<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
        This file is autogenerated from internals/eventloop.html.in
        Do not edit this file. Changes will be lost.
      -->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" href="../main.css" />
    <link rel="SHORTCUT ICON" href="../32favicon.png" />
    <title>libvirt: Libvirt's event loop</title>
    <meta name="description" content="libvirt, virtualization, virtualization API" />
  </head>
  <body>
    <div id="header">
      <div id="headerLogo"></div>
      <div id="headerSearch">
        <form action="../search.php" enctype="application/x-www-form-urlencoded" method="get"><div>
            <input id="query" name="query" type="text" size="12" value="" />
            <input id="submit" name="submit" type="submit" value="Search" />
          </div></form>
      </div>
    </div>
    <div id="body">
      <div id="menu">
        <ul class="l0"><li>
            <div>
              <a title="Front page of the libvirt website" class="inactive" href="../index.html">Home</a>
            </div>
          </li><li>
            <div>
              <a title="Details of new features and bugs fixed in each release" class="inactive" href="../news.html">News</a>
            </div>
          </li><li>
            <div>
              <a title="Applications known to use libvirt" class="inactive" href="../apps.html">Applications</a>
            </div>
          </li><li>
            <div>
              <a title="Get the latest source releases, binary builds and get access to the source repository" class="inactive" href="../downloads.html">Downloads</a>
            </div>
          </li><li>
            <div>
              <a title="Information for users, administrators and developers" class="active" href="../docs.html">Documentation</a>
              <ul class="l1"><li>
                  <div>
                    <a title="How to compile libvirt" class="inactive" href="../compiling.html">Compiling</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Information about deploying and using libvirt" class="inactive" href="../deployment.html">Deployment</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Overview of the logical subsystems in the libvirt API" class="inactive" href="../intro.html">Architecture</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Description of the XML formats used in libvirt" class="inactive" href="../format.html">XML format</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Hypervisor specific driver information" class="inactive" href="../drivers.html">Drivers</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Reference manual for the C public API" class="inactive" href="../html/index.html">API reference</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Bindings of the libvirt API for other languages" class="inactive" href="../bindings.html">Language bindings</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Working on the internals of libvirt API, driver and daemon code" class="active" href="../internals.html">Internals</a>
                    <ul class="l2"><li>
                        <div>
                          <a title="General hacking guidelines for contributors" class="inactive" href="../hacking.html">Contributor guidelines</a>
                        </div>
                      </li><li>
                        <div>
                          <a title="Adding new public libvirt APIs" class="inactive" href="../api_extension.html">API extensions</a>
                        </div>
                      </li><li>
                        <div>
                          <span class="active">Event loop and worker pool</span>
                        </div>
                      </li><li>
                        <div>
                          <a title="Spawning commands from libvirt driver code" class="inactive" href="../internals/command.html">Spawning commands</a>
                        </div>
                      </li><li>
                        <div>
                          <a title="RPC protocol information and API / dispatch guide" class="inactive" href="../internals/rpc.html">RPC protocol &amp; APIs</a>
                        </div>
                      </li><li>
                        <div>
                          <a title="Use lock managers to protect disk content" class="inactive" href="../internals/locking.html">Lock managers</a>
                        </div>
                      </li><li>
                        <div>
                          <a title="Simulating OOM conditions in the test suite" class="inactive" href="../internals/oomtesting.html">Out of memory testing</a>
                        </div>
                      </li></ul>
                  </div>
                </li><li>
                  <div>
                    <a title="A guide and reference for developing with libvirt" class="inactive" href="../devguide.html">Development Guide</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Command reference for virsh" class="inactive" href="../virshcmdref.html">Virsh Commands</a>
                  </div>
                </li><li>
                  <div>
                    <a title="Project governance and code of conduct" class="inactive" href="../governance.html">Governance</a>
                  </div>
                </li></ul>
            </div>
          </li><li>
            <div>
              <a title="User contributed content" class="inactive" href="http://wiki.libvirt.org">Wiki</a>
            </div>
          </li><li>
            <div>
              <a title="Frequently asked questions" class="inactive" href="http://wiki.libvirt.org/page/FAQ">FAQ</a>
            </div>
          </li><li>
            <div>
              <a title="How and where to report bugs and request features" class="inactive" href="../bugs.html">Bug reports</a>
            </div>
          </li><li>
            <div>
              <a title="How to contact the developers via email and IRC" class="inactive" href="../contact.html">Contact</a>
            </div>
          </li><li>
            <div>
              <a title="Available test suites for libvirt" class="inactive" href="../testsuites.html">Test suites</a>
            </div>
          </li><li>
            <div>
              <a title="Miscellaneous links of interest related to libvirt" class="inactive" href="../relatedlinks.html">Related Links</a>
            </div>
          </li><li>
            <div>
              <a title="Overview of all content on the website" class="inactive" href="../sitemap.html">Sitemap</a>
            </div>
          </li></ul>
      </div>
      <div id="content">
        <h1>Libvirt's event loop</h1>
        <ul><li>
            <a href="#event_loop">Event driven programming</a>
          </li><li>
            <a href="#api">The event loop API</a>
          </li><li>
            <a href="#worker_pool">Worker pool</a>
          </li></ul>
        <p>
      This page describes the event loop approach used in
      libvirt. Both server and client.
    </p>
        <h2>
          <a name="event_loop" shape="rect" id="event_loop">Event driven programming</a>
          <a class="headerlink" href="#event_loop" title="Permalink to this headline">¶</a>
        </h2>
        <p>Traditionally, a program simply ran once, then terminated.
    This type of program was very common in the early days of
    computing, and lacked any form of user interactivity. This is
    still used frequently, particularly in small one purpose
    programs.</p>
        <p>However, that approach is not suitable for all the types
    of applications. For instance graphical applications spend
    most of their run time waiting for an input from user. Only
    after it happened (in our example a button was clicked, a key
    pressed, etc.) an event is generated to which they respond
    by executing desired function. If generalized, this is how
    many long running programs (daemons) work. Even those who are
    not waiting for direct user input and have no graphical
    interface. Such as Libvirt.</p>
        <img alt="event loop" src="http://libvirt.org/git/?p=libvirt-media.git;a=blob_plain;f=png/event_loop_simple.png;hb=HEAD" />
        <p>In Libvirt this approach is used in combination with
    <code>poll(2)</code> as all the communication with its
    clients (and domains it manages too) happens through sockets.
    Therefore whenever new client connects, it is given exclusive
    file descriptor which is then watched for incoming events,
    e.g. messages. </p>
        <h2>
          <a name="api" shape="rect" id="api">The event loop API</a>
          <a class="headerlink" href="#api" title="Permalink to this headline">¶</a>
        </h2>
        <p>To work with event loop from our code we have plenty of
    APIs.</p>
        <ul><li><code>virEventAddHandle</code>: Registers a
        callback for monitoring file handle events.</li><li><code>virEventUpdateHandle</code>: Change set of events
        monitored file handle is being watched for.</li><li><code>virEventRemoveHandle</code>: Unregisters
        previously registered file handle so that it is no
        longer monitored for any events.</li><li><code>virEventAddTimeout</code>: Registers a
        callback for timer event.</li><li><code>virEventUpdateTimeout</code>: Changes frequency
        for a timer.</li><li><code>virEventRemoveTimeout</code>: Unregisters
        a timer.</li></ul>
        <p>For more information on these APIs continue reading <a href="../html/libvirt-libvirt-event.html" shape="rect">here</a>.</p>
        <h2>
          <a name="worker_pool" shape="rect" id="worker_pool">Worker pool</a>
          <a class="headerlink" href="#worker_pool" title="Permalink to this headline">¶</a>
        </h2>
        <p>Looking back at the image above we can see one big
    limitation. While processing a message event loop is blocked
    and for an outside observer unresponsive. This is not
    acceptable for Libvirt. Therefore we have came up with the
    following solution.</p>
        <img alt="event loop" src="http://libvirt.org/git/?p=libvirt-media.git;a=blob_plain;f=png/event_loop_worker.png;hb=HEAD" />
        <p>The event loop does only necessary minimum and hand over
    message processing to another thread. In fact, there can be
    as many processing threads as configured increasing
    processing power.</p>
        <p>To break this high level description into smaller pieces,
    here is what happens when user calls an API:</p>
        <ol><li>User (or management application) calls a Libvirt API.
      Depending on the connection URI, this may or may not
      involve server. Well, for the sake of our
      demonstration we assume the former.</li><li>Remote driver encodes the API among it's arguments
      into an <a href="rpc.html" shape="rect">RPC message</a> and sends
      it to the server.</li><li>Here, server is waiting in <code>poll(2)</code> for
      an event, like incoming message.</li><li>As soon as the first bytes of message are received,
      even loop wakes up and server starts reading the
      whole message.</li><li>Once fully read, the event loop notifies threads
      known as worker threads from which one picks the incoming
      message, decodes and process it.</li><li>As soon as API execution is finished, a reply is sent
      to the client.</li></ol>
        <p>In case that there's no free worker to process an incoming
    message in step 5, message is placed at the end of a message
    queue and is processed in next iteration.</p>
      </div>
    </div>
  </body>
</html>
